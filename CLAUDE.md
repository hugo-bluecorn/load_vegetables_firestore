# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Flutter application for managing a vegetables list with local storage persistence. Despite the name `load_vegetables_firestore`, the app currently uses SharedPreferences for local storage (not Firebase/Firestore). The project uses Flutter SDK ^3.9.2 and targets multiple platforms (Android, Web).

### Current Features
- Full CRUD operations for vegetables (Create, Read, Update, Delete)
- Vegetable model with timestamps (createdAt, lastUpdatedAt) and harvest state tracking
- Gesture-based UI (swipe to delete, long press for selection mode)
- Multi-select mode with batch operations (edit, delete, move)
- Harvest state filtering with tabbed navigation (Plenty, Enough, Scarce)
- Local data persistence using SharedPreferences with JSON format
- Automatic data migration from legacy List<String> format to new JSON format
- File import from text files with duplicate detection
- Declarative routing with GoRouter
- Material 3 UI with dialogs for user interactions
- Riverpod state management with AsyncNotifier pattern

## Development Commands

### Setup
```bash
flutter pub get                    # Install dependencies
```

### Running the Application
```bash
flutter run                        # Run on connected device/emulator
flutter run -d chrome              # Run on Chrome (web)
flutter run -d android             # Run on Android device/emulator
```

### Building
```bash
flutter build apk                  # Build Android APK
flutter build appbundle            # Build Android App Bundle
flutter build web                  # Build for web deployment
```

### Testing
```bash
flutter test                       # Run all tests (38 tests total)
flutter test --coverage            # Run tests with coverage report
flutter test test/providers/vegetable_notifier_test.dart  # Run notifier tests only
flutter test test/widget_test.dart # Run widget tests only
```

**Test Structure:**
- `test/providers/vegetable_notifier_test.dart` - 18 unit tests for VegetablesNotifier
- `test/widget_test.dart` - 17 widget tests for UI functionality
- Tests use Riverpod's `ProviderContainer` for isolated testing
- Tests use `SharedPreferences.setMockInitialValues()` for data mocking
- Tests use `createMockVegetablesJson()` helper to create mock Vegetable data
- Coverage reports generated in `coverage/lcov.info`

### Code Generation
```bash
dart run build_runner build                          # Generate mapper code
dart run build_runner build --delete-conflicting-outputs  # Force regenerate
dart run build_runner watch                          # Watch mode for development
```

**Generated Files:**
- `lib/ui/vegetable_list/models/vegetable.mapper.dart` - Auto-generated by dart_mappable
- This file is committed to version control as it's required for the app to run

### Code Quality
```bash
flutter analyze                    # Run static analysis
dart format .                      # Format all Dart files
dart format lib/                   # Format only lib directory
```

### Cleaning
```bash
flutter clean                      # Clean build artifacts
flutter pub get                    # Reinstall dependencies after clean
```

## Architecture

### Project Structure
```
lib/
â”œâ”€â”€ main.dart                                          # Application entry point with ProviderScope
â”œâ”€â”€ routing/
â”‚   â”œâ”€â”€ app_router.dart                               # GoRouter configuration and routes
â”‚   â””â”€â”€ harvest_state_shell_screen.dart               # Navigation shell with bottom bar
â””â”€â”€ ui/
    â””â”€â”€ vegetable_list/
        â”œâ”€â”€ models/
        â”‚   â”œâ”€â”€ vegetable.dart                        # Vegetable model with HarvestState enum
        â”‚   â””â”€â”€ vegetable.mapper.dart                 # Generated mapper code (dart_mappable)
        â”œâ”€â”€ providers/
        â”‚   â””â”€â”€ vegetable_providers.dart              # Riverpod providers and notifiers
        â”œâ”€â”€ view_model/
        â”‚   â””â”€â”€ vegetable_list_view_model.dart        # VegetableService - data layer
        â””â”€â”€ widgets/
            â”œâ”€â”€ vegetable_list_screen.dart            # Main screen (ConsumerStatefulWidget)
            â”œâ”€â”€ vegetables_list_view.dart             # List display widget
            â”œâ”€â”€ vegetable_list_item.dart              # Individual list item with gestures
            â”œâ”€â”€ add_vegetable_dialog.dart             # Add dialog
            â”œâ”€â”€ edit_vegetable_dialog.dart            # Edit dialog
            â”œâ”€â”€ delete_vegetable_dialog.dart          # Delete confirmation dialog
            â”œâ”€â”€ move_vegetables_dialog.dart           # Move dialog for batch harvest state update
            â””â”€â”€ import_button.dart                     # File import button (ConsumerWidget)

test/
â”œâ”€â”€ widget_test.dart                                   # Widget/UI tests (17 tests)
â””â”€â”€ providers/
    â””â”€â”€ vegetable_notifier_test.dart                   # Notifier tests (18 tests)

android/                                               # Android-specific configuration
web/                                                   # Web-specific assets
build/                                                 # Build artifacts (git-ignored)
coverage/                                              # Coverage reports (git-ignored)
```

### Design Patterns
The application follows a **feature-based organization** with **Riverpod state management**:

**Routing Layer** (`lib/routing/`):
- `GoRouter` configuration with declarative routing
- Managed through Riverpod provider (`goRouterProvider`)
- StatefulShellRoute with tabbed navigation for harvest states
- Three routes: `/plenty`, `/enough`, `/scarce` (default: `/plenty`)
- `HarvestStateShellScreen` - Navigation shell with color-coded bottom navigation bar
- Deep linking support enabled for web platform
- Debug logging for route diagnostics

**Model Layer** (`lib/ui/vegetable_list/models/`):
- `Vegetable` - Main data model using dart_mappable for JSON serialization
  - `name` (String) - The vegetable name
  - `harvestState` (HarvestState enum) - scarce, enough, or plenty (default: scarce)
  - `createdAt` (DateTime) - When the vegetable was added (default: now)
  - `lastUpdatedAt` (DateTime) - Last modification timestamp (default: now)
- `HarvestState` - Enum for tracking harvest availability
- `VegetableMapper` - Auto-generated serialization code
- Uses `@MappableClass()` and `@MappableEnum()` annotations
- Provides `copyWith()`, `toMap()`, and `fromMap()` methods

**State Management Layer** (`lib/ui/vegetable_list/providers/`):
- `VegetablesNotifier` - AsyncNotifier managing vegetables state reactively
- Works with `List<Vegetable>` instead of `List<String>`
- Provides methods:
  - `add()`, `updateVegetable()`, `delete()` - Single item operations
  - `deleteMultiple()`, `updateHarvestStateForMultiple()` - Batch operations
  - `import()`, `refresh()` - Import and reload operations
- Uses `AsyncValue` for loading/error/data states
- Automatic state updates and UI rebuilds
- `vegetableServiceProvider` - Provides VegetableService singleton
- `vegetablesProvider` - Main provider for vegetables state

**UI Layer** (`lib/ui/vegetable_list/widgets/`):
- `VegetableListScreen` - Main container using `ConsumerStatefulWidget` with local selection state
  - Filters vegetables by harvest state parameter
  - Manages multi-select mode state and selected items
  - Dynamic AppBar with selection actions (edit, delete, move)
  - PopScope handling for back button during selection mode
- `VegetablesListView` - Presentation widget for list display
- `VegetableListItem` - Reusable component with gesture and selection support:
  - **Dismissible widget** for swipe-to-delete (disabled in selection mode)
  - **Long press** gesture for entering selection mode
  - **Checkbox** leading widget when in selection mode
  - Displays vegetable name, created timestamp, and last updated timestamp
  - Three-line ListTile format with formatted dates
- Dialog widgets - Modular, reusable dialogs for user interactions:
  - `AddVegetableDialog` - Add new vegetables with harvest state selection
  - `EditVegetableDialog` - Edit existing vegetables
  - `DeleteVegetableDialog` - Confirmation for single deletions
  - `MoveVegetablesDialog` - Batch harvest state updates
- `ImportButton` - Self-contained import functionality using `ConsumerWidget`
- Widgets use `ref.watch()` to observe state and `ref.read()` to trigger actions

**Data Layer** (`lib/ui/vegetable_list/view_model/`):
- `VegetableService` - Handles all CRUD operations and data persistence
- Methods are async and return Futures
- Works with `Vegetable` objects and uses `VegetableMapper` for serialization
- Supports single and batch operations:
  - `addVegetable()`, `updateVegetable()`, `deleteVegetable()` - Single operations
  - `deleteMultiple()`, `updateHarvestStateForMultiple()` - Batch operations
- Import functionality includes case-insensitive duplicate detection
- **Data Migration**: Automatically detects and converts old `List<String>` format to new JSON format
- Isolated from UI through provider layer

### Data Persistence
The app uses SharedPreferences for local storage. All vegetables are stored as a JSON string under the key `'vegetables'`.

**Storage Format:**
- **Current format** (v0.5.0+): JSON string of Vegetable objects
  ```json
  [
    {
      "name": "Carrot",
      "harvestState": "scarce",
      "createdAt": "2025-11-05T14:30:00.000",
      "lastUpdatedAt": "2025-11-05T14:30:00.000"
    }
  ]
  ```
- **Legacy format** (v0.4.0 and earlier): `List<String>` of vegetable names
  - Automatically migrated on first load in v0.5.0+
  - Migration preserves vegetable names and sets default timestamps

**Service Layer:**
- `VegetableService` provides a clean API for data operations
- All persistence logic is isolated from UI components
- Uses `VegetableMapper.fromMap()` for deserialization
- Uses `vegetable.toMap()` for serialization
- Supports: load, save, add, update, delete, and import operations
- `loadVegetables()` handles automatic data migration transparently

**Migration Logic:**
1. Try to load as JSON string (new format)
2. If not found, check for old `List<String>` format
3. Convert old data to `Vegetable` objects with default timestamps and harvest state
4. Save in new JSON format
5. Return migrated data

### Future Firebase Integration
The project name suggests Firebase/Firestore integration may be planned. Firebase configuration files are git-ignored for security:
- `firebase.json`
- `android/app/google-services.json`
- `lib/firebase_options.dart`
- `web/firebase-messaging-sw.js`
- iOS/macOS: `GoogleService-Info.plist`
- Windows: `google-services.json`

**Note**: These files must be obtained from the Firebase Console and never committed to version control.

### Linting
The project uses `flutter_lints` (^6.0.0) with the standard Flutter linting rules from `package:flutter_lints/flutter.yaml`.

## Platform Support
Currently configured for:
- Android (using Gradle with Kotlin DSL)
- Web (with PWA manifest support)

The app uses Material Design (`uses-material-design: true` in pubspec.yaml).

## Dependencies

### Production Dependencies
- `flutter_riverpod: ^3.0.3` - State management solution
- `go_router: ^16.3.0` - Declarative routing and navigation
- `shared_preferences: ^2.3.3` - Local data persistence
- `file_picker: ^10.3.3` - File selection functionality
- `dart_mappable: ^4.2.2` - Model serialization and JSON mapping
- `intl: ^0.20.0` - Date formatting for timestamps

### Dev Dependencies
- `flutter_lints: ^6.0.0` - Code quality and linting
- `build_runner: ^2.4.13` - Code generation runner
- `dart_mappable_builder: ^4.2.3` - Generates mapper code for models

## UI Interactions

### Gesture-Based Actions

**Normal Mode:**
- **Add Vegetable**: Tap the floating action button (âž•)
- **Delete Vegetable**: Swipe left on any vegetable item
- **Enter Selection Mode**: Long press on any vegetable item
- **Import File**: Tap the upload icon (ðŸ“¤) in the app bar

**Selection Mode:**
- **Toggle Selection**: Tap on any vegetable item
- **Edit Single Item**: Tap edit icon (only enabled when 1 item selected)
- **Delete Selected**: Tap delete icon, confirms before deletion
- **Move Selected**: Tap move icon to change harvest state for all selected
- **Exit Selection Mode**: Tap close (X) icon or press back button

### Timestamp Behavior
- `createdAt`: Set when vegetable is first added (never changes)
- `lastUpdatedAt`: Set when vegetable is added, updated on every edit
- Both timestamps are displayed in the UI with format: "MMM d, y h:mm a"

### Harvest State
- Displayed via tabbed navigation with color-coded themes
- Default value when adding vegetables: Current tab's harvest state
- Enum values: `scarce` (ðŸŒ±), `enough` (ðŸŒ¿), `plenty` (ðŸŒ¾)
- Each tab has unique theme color:
  - Plenty: Amber/Yellow (Colors.amber)
  - Enough: Blue (Colors.blue)
  - Scarce: Deep Purple (Colors.deepPurple)
- Can be changed individually (add/edit dialogs) or in batch (move dialog)

## Development Guidelines
- Always run `flutter pub upgrade --major-versions` after running `flutter pub get`
- Always ask to update @CHANGLOG.md and @README.md before a git push
- Run `dart run build_runner build` after modifying model classes with dart_mappable annotations
- The generated `*.mapper.dart` files should be committed to version control